<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: components/historique/HistoriqueAccountSpec.jsx</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: components/historique/HistoriqueAccountSpec.jsx</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { useEffect, useState } from "react";
import Cookies from "js-cookie";
import AfficheModal from "./HistoriqueModalSpec";

/**
 * Formats a date string into "DD/MM/YYYY".
 *
 * @param {string} dateString - The input date string
 * @returns {string} Formatted date
 */
function formatDate(dateString) {
  return new Date(dateString).toLocaleDateString("fr-FR", {
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
  });
}

/**
 * Historique component.
 *
 * Fetches and displays the transaction history for all user accounts, including
 * deposits, withdrawals, and transfers. Allows viewing transaction details in a modal.
 *
 * @component
 */
export default function Historique() {
  const [transactions, setTransactions] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selectedTransaction, setSelectedTransaction] = useState(null);

  const token = Cookies.get("access_token");
  const user = JSON.parse(localStorage.getItem("user"));
  const userId = user?.id;

  useEffect(() => {
    if (!userId || !token) return;

    /**
     * Loads all transactions for the user's accounts.
     *
     * Fetches deposits, withdrawals, and transfers, then merges and sorts them
     * by date descending.
     */
    async function loadAllTransactions() {
      try {
        const accountsRes = await fetch("http://127.0.0.1:8000/accounts/", {
          headers: { Authorization: `Bearer ${token}` },
        });

        if (!accountsRes.ok) {
          console.warn("Impossible d'obtenir les comptes :", accountsRes.status);
          setLoading(false);
          return;
        }

        const accounts = await accountsRes.json();
        if (!accounts.length) {
          console.log("Aucun compte trouvé");
          setLoading(false);
          return;
        }

        let allTransactions = [];
        const accountMap = {};
        accounts.forEach(acc => { accountMap[acc.id] = acc.type; });

        for (const acc of accounts) {
          const [depositsRes, withdrawsRes] = await Promise.all([
            fetch(`http://127.0.0.1:8000/balances/deposits/${acc.id}`, {
              headers: { Authorization: `Bearer ${token}` },
            }),
            fetch(`http://127.0.0.1:8000/balances/withdraws/${acc.id}`, {
              headers: { Authorization: `Bearer ${token}` },
            }),
          ]);

          const deposits = depositsRes.ok ? await depositsRes.json() : [];
          const withdraws = withdrawsRes.ok ? await withdrawsRes.json() : [];

          allTransactions.push(
            ...deposits.map(d => ({
              date: formatDate(d.date),
              label: `Dépôt sur ${acc.type}`,
              amount: `+${d.amount}€`,
              category: "Dépôt",
            }))
          );

          allTransactions.push(
            ...withdraws.map(w => ({
              date: formatDate(w.date),
              label: `Retrait sur ${acc.type}`,
              amount: `-${w.amount}€`,
              category: "Retrait",
            }))
          );
        }

        const transfersRes = await fetch(`http://127.0.0.1:8000/balances/transfers`, {
          headers: { Authorization: `Bearer ${token}` },
        });

        if (transfersRes.ok) {
          const transfers = await transfersRes.json();

          allTransactions.push(
            ...transfers.map(t => {
              const isSent = accounts.some(acc => acc.id === t.from_account_id);
              const fromType = accountMap[t.from_account_id] || `Compte ${t.from_account_id}`;
              const toType = accountMap[t.to_account_id] || `Compte ${t.to_account_id}`;

              return {
                date: formatDate(t.date),
                label: isSent
                  ? `Virement envoyé vers ${toType}`
                  : `Virement reçu de ${fromType}`,
                amount: isSent ? `-${t.amount}€` : `+${t.amount}€`,
                category: "Virement",
                from_account: fromType,
                to_account: toType,
              };
            })
          );
        }

        allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

        setTransactions(allTransactions);
      } catch (error) {
        console.error("Erreur chargement historique :", error);
      } finally {
        setLoading(false);
      }
    }

    loadAllTransactions();
  }, [userId, token]);

  if (loading) return &lt;p>Chargement...&lt;/p>;

  return (
    &lt;div className="transaction-container">
      &lt;h2>Historique des transactions&lt;/h2>

      {transactions.length === 0 ? (
        &lt;p>Aucune transaction trouvée.&lt;/p>
      ) : (
        transactions.map((t, i) => (
          &lt;button
            key={i}
            className="transaction-item"
            onClick={() => setSelectedTransaction(t)}
          >
            &lt;div className="transaction-left">
              &lt;span className="transaction-beneficiary">{t.label}&lt;/span>
              &lt;span className="transaction-category transaction-date">{t.date}&lt;/span>
            &lt;/div>
            &lt;div className="transaction-saldo">{t.amount}&lt;/div>
          &lt;/button>
        ))
      )}

      {selectedTransaction &amp;&amp; (
        &lt;AfficheModal
          transaction={selectedTransaction}
          onClose={() => setSelectedTransaction(null)}
        />
      )}
    &lt;/div>
  );
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#formatDate">formatDate</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Thu Dec 18 2025 15:51:21 GMT+0100 (heure normale d’Europe centrale)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
